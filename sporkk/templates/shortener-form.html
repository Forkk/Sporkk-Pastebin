{% extends "submit-form.html" %}
{% block title %}Sporkk - URL Shortener{% endblock %}

{% block form %}
<div id="shorten_form_div">
	<form name="shorten" id="shorten_form" action="" method="POST">
		<legend>Shorten URL</legend>
		<div class="input-append">
			<input type="url" name="longurl" id="longurl" 
				placeholder="URL to shorten..." class="input-large" 
				tabindex="1" autocomplete="off" required />
			<button type="submit" id="submit" name="action" value="shorten" class="btn" tabindex="2">Shorten URL</button>
		</div>
	</form>
</div>
{% endblock %}

{% block js_body %}
{{ super() }}

<script type='text/javascript' src="/static/js/jquery-ui.min.js"></script>

<script type='text/javascript'>

function createAlertDiv(content, title, alertType, alertBlock, closeCallback)
{
	if (typeof(alertBlock) === 'undefined')
		alertBlock = false;
	if (typeof(closeCallback) === 'undefined')
		closeCallback = null;

	var alertDiv = $('<div class="alert"></div>').hide();
	var alertDivText = $('<span>' + content + '</span>');
	var alertDivClose = $('<button type="button" class="close">&times;</button>');

	switch (alertType)
	{
	case "success":
		alertDiv.addClass("alert-success");
		break;

	case "error":
		alertDiv.addClass("alert-error");
		break;
	}

	var alertDivTitle;
	if (alertBlock)
	{
		alertDivTitle = $('<h4>' + title + '</h4>');
		alertDiv.addClass("alert-block");
	}
	else
	{
		alertDivTitle = $('<strong>' + title + '</strong>');
	}

	alertDiv.append(alertDivClose);
	alertDiv.append(alertDivTitle);
	alertDiv.append(alertDivText);

	if (closeCallback == null)
	{
		alertDivClose.click(function() 
		{
			alertDiv.slideUp(300, function() { alertDiv.remove(); });
		});
	}
	else
	{
		alertDivClose.click(closeCallback);
	}

	return { div: alertDiv, bodySpan: alertDivText, titleBlock: alertDivTitle, closeBtn: alertDivClose };
}

$(document).ready(function()
{
	var shortenForm = $("form#shorten_form");
	var shortenFormDiv = $("div#shorten_form_div");

	var shortenBtn = $("button#submit");
	var urlInput = $("input#longurl");

	shortenForm.submit(function()
	{
		var postData = 'longurl=' + encodeURIComponent(urlInput.val());

		const aniTime = 200;

		function showAlertDiv(msg, title, type)
		{
			alertDivObj = createAlertDiv(msg, title, type, true, function()
				{
					$(alertDivObj.div).hide("slide", { direction: "up" }, aniTime, function()
						{
							shortenForm.show("slide", { direction: "up" }, aniTime);
							alertDivObj.div.remove();
						});
				});

			shortenFormDiv.append(alertDivObj.div);
			shortenForm.hide("slide", { direction: "up" }, aniTime, function()
				{
					$(alertDivObj.div).show("slide", { direction: "up" }, aniTime);
				});
		}

		$.ajax({
			type: "POST",
			url: "/short/submit/json",
			data: postData,
			dataType: "json",

			success: function(data, textStatus)
			{
				if (data.error)
				{
					var errorMsg;
					switch (data.errorType)
					{
					case "bad-longurl":
						errorMsg = "Please specify a valid URL.";
						break;

					case "too-fast":
						errorMsg = "You're posting too fast! Please wait {{ post_cooldown }} seconds between posts!";
						break;

					default:
						errorMsg = "An unknown error occurred: " + data.errorType;
						break;
					}

					showAlertDiv(errorMsg, "Error", "error");

					return;
				}

				showAlertDiv("Your URL was shortened to <a href='/" + data.url + "'>" + data.url + "</a>.",
					"URL Shortened", "success");
			},
		});

		return false;
	});
});
</script>

{% endblock %}